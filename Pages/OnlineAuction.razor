@page "/online-auction"
@inject LivestockAuction.Services.LotService LotService
@inject LivestockAuction.Services.OnlineAuctionService OnlineAuctionService
@inject ISnackbar Snackbar
@using static MudBlazor.Icons.Material.Filled

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">
        <MudIcon Icon="@Icons.Material.Filled.Pets" Class="mr-3" />
        Subasta de Ganado en Vivo
    </MudText>
    
    <MudGrid>
        <MudItem xs="12">
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h5" Class="mb-2 d-flex align-center justify-center">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                    Información de la Subasta
                </MudText>

                <MudList T="string" Dense="true">
                    <MudListItem>
                        <MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center">
                            <!-- Número de Subasta -->
                            <MudItem xs="6">
                                <MudListItem Icon="@Icons.Material.Filled.Tag" IconColor="Color.Primary">
                                    <MudStack AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Spacing="1">
                                        <MudText Typo="Typo.body1">Número de Subasta</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@OnlineAuctionService.GetAuctionNumber()</MudText>
                                    </MudStack>
                                </MudListItem>
                            </MudItem>

                            <!-- Fecha de Subasta -->
                            <MudItem xs="6">
                                <MudListItem Icon="@Icons.Material.Filled.CalendarToday" IconColor="Color.Secondary">
                                    <MudText Typo="Typo.body1">Fecha de Subasta</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@OnlineAuctionService.GetAuctionDate().ToShortDateString()</MudText>
                                </MudListItem>
                            </MudItem>
                        </MudGrid>
                    </MudListItem>
                </MudList>
            </MudPaper>
        </MudItem>
       
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h5" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Visibility" Class="mr-2" />
                    Transmisión en vivo
                </MudText>
                <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                    <iframe src="@($"https://www.youtube.com/embed/{YouTubeVideoId}")"
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;"
                            allowfullscreen="" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
                    </iframe>
                </div>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h5" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.MonetizationOn" Class="mr-2" />
                    Pujas Actuales
                </MudText>
                <MudList T="string" Dense="true">
                    @foreach (var bid in OnlineAuctionService.GetCurrentBids())

                    {

                        var bidderInfo = $"{bid.BidderName} ({bid.BidderNumber})";

                        var bidAmount = $"${bid.Amount}";
                        <MudListItem Text="@bidderInfo"
                                     SecondaryText="@bidAmount"
                                     Icon="@Icons.Material.Filled.Person"
                                     IconColor="Color.Primary" />
                    }
                </MudList>
            </MudPaper>
        </MudItem>
    </MudGrid>


    <MudGrid>
        <MudItem xs="12" md="8">
            <MudPaper Class="pa-4 mb-4">
                <MudText Typo="Typo.h5" Class="mb-2">
                    <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                    Información del Lote
                </MudText>
                @{
                    var lotInfo = OnlineAuctionService.GetCurrentLotInfo();
                }
                <MudGrid>
                    <MudItem xs="12" sm="6">
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.Person">
                                <MudText>Vendedor: @lotInfo.Vendedor</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Pets">
                                <MudText>Tipo de Ganado: @lotInfo.TipoGanado</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                                <MudText>Probado: @lotInfo.Probado</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Receipt">
                                <MudText>Con Factura: @lotInfo.ConFactura</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Category">
                                <MudText>Raza: @lotInfo.Raza</MudText>
                            </MudListItem>
                        </MudList>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudList T="string" Dense="true">
                            <MudListItem Icon="@Icons.Material.Filled.Numbers">
                                <MudText>Cantidad: @lotInfo.Cantidad</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Scale">
                                <MudText>Peso Promedio: @lotInfo.PesoPromedio kg</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.MonetizationOn">
                                <MudText>Precio de Salida: $@lotInfo.PrecioSalida</MudText>
                            </MudListItem>
                            <MudListItem Icon="@Icons.Material.Filled.Description">
                                <MudText>Descripción: @lotInfo.Descripcion</MudText>
                            </MudListItem>
                        </MudList>

                    </MudItem>
                </MudGrid>
                <MudTextField T="string" Label="Ingrese su puja" Variant="Variant.Outlined" Class="mt-4" @bind-Value="_bidAmount" />
                <MudButton Variant="Variant.Filled" Color="Color.Success" FullWidth="true" Class="mt-2" OnClick="PlaceBid">Colocar Puja</MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudPaper Class="pa-4 mt-4">
        <MudText Typo="Typo.h5" Class="mb-4">
            <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Class="mr-2" />
            Compras Realizadas
        </MudText>
        <MudTable Items="@OnlineAuctionService.GetPurchases()" Hover="true" Striped="true" Dense="true">
            <HeaderContent>
                <MudTh>Raza</MudTh>
                <MudTh>Descripción</MudTh>
                <MudTh>No. Cabezas</MudTh>
                <MudTh>Kilos del Lote</MudTh>
                <MudTh>Precio por Kilo</MudTh>
                <MudTh>Total</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Raza">@context.Raza</MudTd>
                <MudTd DataLabel="Descripción">@context.Descripcion</MudTd>
                <MudTd DataLabel="No. Cabezas">@context.NoCabezas</MudTd>
                <MudTd DataLabel="Kilos del Lote">@context.KilosLote kg</MudTd>
                <MudTd DataLabel="Precio por Kilo">$@context.PrecioPorKilo.ToString("F2")</MudTd>
                <MudTd DataLabel="Total">$@context.Total.ToString("F2")</MudTd>
            </RowTemplate>
            <FooterContent>
                <MudTh>Totales:</MudTh>
                <MudTh></MudTh>
                <MudTh>@OnlineAuctionService.GetPurchases().Sum(p => p.NoCabezas)</MudTh>
                <MudTh>@OnlineAuctionService.GetPurchases().Sum(p => p.KilosLote) kg</MudTh>
                <MudTh>$@(OnlineAuctionService.GetPurchases().Sum(p => p.PrecioPorKilo * p.KilosLote) / OnlineAuctionService.GetPurchases().Sum(p => p.KilosLote)).ToString("F2")</MudTh>
                <MudTh>$@OnlineAuctionService.GetPurchases().Sum(p => p.Total).ToString("F2")</MudTh>
            </FooterContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<LivestockAuction.Services.Lot> _lots = new List<LivestockAuction.Services.Lot>();
    private LivestockAuction.Services.Lot? _selectedLot;
    private string _bidAmount = "";
    private string YouTubeVideoId = "dQw4w9WgXcQ"; // Replace with your actual YouTube video ID

    protected override void OnInitialized()
    {
        _lots = LotService.GetLots();
    }

    private void PlaceBid()
    {
        if (_selectedLot == null || !decimal.TryParse(_bidAmount, out decimal bidAmount) || bidAmount <= _selectedLot.CurrentBid)
        {
            Snackbar.Add("La oferta debe ser mayor que la oferta actual.", Severity.Warning);
            return;
        }

        LotService.PlaceBid(_selectedLot.Id, bidAmount);
        _selectedLot.CurrentBid = bidAmount;
        Snackbar.Add($"Oferta de ${bidAmount} realizada con éxito para {_selectedLot.Description}.", Severity.Success);
        _bidAmount = (bidAmount + 1).ToString();

        // Update CurrentBids list using the service
        OnlineAuctionService.AddBid("Usuario Actual", "No-XXXX", bidAmount);
    }
}